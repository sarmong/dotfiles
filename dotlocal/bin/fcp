#!/usr/bin/env bash

tty >/dev/null 2>&1
is_tty="$?"

get_file() {
  pipe="/tmp/fcp"
  mkfifo $pipe
  trap 'rm $pipe' EXIT

  fd --type f --exclude 'node_modules' . "$HOME" | cut -d/ -f4- >"$pipe" &

  if [ $is_tty -eq 0 ]; then
    file=$(fzf --multi <"$pipe")
  else
    file=$(rofi -dmenu -i -p "Select file" -multi-select <"$pipe")
  fi

  echo "$file"
}

copy() {
  links=$(echo "$@" | xargs realpath | xargs -I {} echo "file://{}")

  echo "$links" | xclip -sel clipboard -t text/uri-list

  if [ $is_tty -eq 0 ]; then
    echo "Successfully copied:"
    echo "$@"
  else
    notify-send "FCP" "Copied:\n$*"
  fi
}

drag() {
  echo "$@" | sed "s|^|$HOME/|" | xargs -d '\n' dragon-drop -a
}

case "$1" in
  "-d" | "--drag")
    shift
    drag "${@-$(get_file)}"
    ;;
  *)
    copy "${@-$(get_file)}"
    ;;
esac
