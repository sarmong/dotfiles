#!/bin/sh

# shellcheck disable=1007
script_dir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)

cd "$script_dir" || exit 1

existing_files=".bash_logout .bashrc .bash_profile"

for file in ${existing_files}; do
  path="$HOME/$file"
  # rename old files only if they are not links
  [ -f "$path" ] && [ ! -L "$path" ] && mv "$path" "$HOME/$file-old"
done

mkdir ~/.local
mkdir ~/.config

Darwin="bash git nvim lf scripts vim alacritty newsboat tmux archive/macos/skhd archive/macos/spacebar archive/macos/yabai"

Linux="bash zsh git nvim lf scripts vim alacritty newsboat tmux bottom conky npm awesome rofi libinput-gestures picom mpv xorg udiskie bspwm polybar sxhkd kitty eww"

if [ "$(uname)" = "Darwin" ]; then
  dirs=${Darwin}
elif [ "$(uname)" = "Linux" ]; then
  dirs=${Linux}
fi

for dir in ${dirs}; do
  dirname="$(dirname "$dir")"
  pkgname="$(basename "$dir")"

  cd "$dirname" || exit 1

  stow -v --target="$HOME" "$pkgname"

  cd "$script_dir" || exit 1
done

cp "$script_dir"/npm/.config/npm/npmrc-template "$script_dir"/npm/.config/npm/npmrc

# TODO doesn't export
# Source env variables so that they are available immediately
. "$script_dir/bash/.config/bash/bash-exports"
