- name: Link dotfiles
  include_tasks: link.yml
  loop:
    - src: "{{ XDG_DOTFILES_DIR }}/dotconfig"
      dest: "{{ XDG_CONFIG_HOME }}"
    - src: "{{ XDG_DOTFILES_DIR }}dotlocal/share/applications"
      dest: "{{ XDG_DATA_HOME }}/applications"
    - src: "{{ XDG_DOTFILES_DIR }}/dotlocal/xdg/icons"
      dest: ~/.local/xdg/icons
    - src: "{{ XDG_DOTFILES_DIR }}/dotlocal/bin"
      dest: ~/.local
      itself: true

- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ XDG_CONFIG_HOME }}/systemd/user"
    - "{{ XDG_CONFIG_HOME }}/npm"

- name: Corrent npmrc config (for XDG cleanup)
  lineinfile:
    path: "{{ XDG_CONFIG_HOME }}/npm/npmrc"
    line: "{{ item }}"
    mode: "0644"
    create: true
  loop:
    - prefix="{{ XDG_DATA_HOME }}/npm"
    - cache="{{ XDG_CACHE_HOME }}/npm"
    - init-module="{{ XDG_CONFIG_HOME }}/npm/config/npm-init.js"

- name: load env vars for any login shell # lightdm reads this file
  become: true
  copy:
    src: user_env.sh
    dest: "{{ item }}"
    mode: preserve
  loop:
    - /etc/profile.d/user_env.sh
    - /etc/zsh/user_env.sh

- name: load env vars for zsh tty
  become: true
  blockinfile:
    path: /etc/zsh/zshenv ## for some reason zprofile is not loaded
    block: |
      env_file="/etc/zsh/user_env.sh"
      [ -f "$env_file" ] && . "$env_file"

- name: Copy encrypted files
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: preserve
  loop:
    - src: "{{ XDG_DOTFILES_DIR }}/dotconfig/zsh/zsh-local-enc"
      dest: "{{ XDG_DOTFILES_DIR }}/dotconfig/zsh/zsh-local"
    - src: "{{ XDG_DOTFILES_DIR }}/dotconfig/git/git-work-enc.conf"
      dest: "{{ XDG_DOTFILES_DIR }}/dotconfig/git/git-work.conf"
    - src: "{{ XDG_DOTFILES_DIR }}/dotconfig/git/git-personal-enc.conf"
      dest: "{{ XDG_DOTFILES_DIR }}/dotconfig/git/git-personal.conf"
