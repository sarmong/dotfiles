#!/bin/sh

# If no url given. Opens browser. For using script as $BROWSER.
[ -z "$1" ] && {
  "$BROWSER"
  exit
}

mpv_same_desktop() {
  focused_desktop="$(bspc query -D -d focused)"
  is_mpv_open=$(echo '{ "command": ["get_property", "playlist"] }' | socat - /tmp/mpvsocket | jq '.data')

  if [ -z "$is_mpv_open" ]; then
    bspc rule -a mpv --one-shot desktop="$focused_desktop"
    notify-send --app-name="Newsboat" "Newsboat" "Opening mpv..."
  else
    notify-send --app-name="Newsboat" "Newsboat" "Adding video to current mpv instance..."
  fi
}

case "$1" in
  *mkv | *webm | *mp4 | *youtube.com/watch* | *youtube.com/playlist* | *youtu.be* | *hooktube.com* | *bitchute.com* | *videos.lukesmith.xyz* | *odysee.com*)
    mpv_same_desktop

    setsid -f umpv "$1" >/dev/null 2>&1
    ;;

  *png | *jpg* | *jpe | *jpeg | *gif)
    setsid -f feh "$1"
    ;;

  *pdf | *cbz | *cbr)
    setsid -f zathura "$1"
    ;;

  *mp3 | *flac | *opus | *mp3?source*)
    qndl "$1" 'curl -LO' >/dev/null 2>&1
    ;;
  *)
    [ -f "$1" ] && setsid -f "$TERMINAL" -e "$EDITOR" "$1" >/dev/null 2>&1 || setsid -f firefox "$1" >/dev/null 2>&1
    ;;
esac
